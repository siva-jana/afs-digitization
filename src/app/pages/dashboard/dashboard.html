<div class="dashboard-page">

  <!-- Top Controls -->
  <div class="top-controls">
    <div class="metrics-box">
      <div class="metrics-section">
        <h3>Overall <span class="highlight">digitized</span> {{ globalMetrics.digitizedPages + globalMetrics.failedFiles }} pages in {{ globalMetrics.digitizedFiles + globalMetrics.failedFiles }} files</h3>
        <div class="metrics-grid">
          <div class="metrics-left">
            <p>Files Digitized: {{ globalMetrics.digitizedFiles }}</p>
            <p>Pages Digitized: {{ globalMetrics.digitizedPages }}</p>
            <p>Files Failed: <span class="error-number">{{ globalMetrics.failedFiles }}</span></p>
            <p>Pages Failed: <span class="error-number">{{ globalMetrics.failedFiles }}</span></p>
          </div>
          <div class="vertical-separator"></div>
          <div class="metrics-right">
            <div class="success-rate">{{ getGlobalSuccessRate() }}%</div>
            <div class="success-label">Successful Digitization</div>
          </div>
        </div>
      </div>
    </div>
    
    
  <button class="download-btn" (click)="downloadExcel()">Download</button>
    <div class="top-actions">
      
      <div class="profile-icon" (click)="togglePopup()">üë§</div>
    </div>
  </div>

  <!-- Profile Popup -->
  <div class="profile-popup" *ngIf="showPopup">
    <div class="close-btn" (click)="togglePopup()">√ó</div>
    <div class="popup-content">
      <div class="avatar-large">üë§</div>
      <div><strong>Name:</strong> {{ fullName }}</div>
      <div><strong>Email:</strong> {{ email }}</div>
      <div><strong>Role:</strong> {{ role }}</div>
      <div><strong>Last Login:</strong> {{ lastLoginTime | date:'short' }}</div>
      <button class="logout-btn" (click)="logout()">Logout</button>
    </div>
  </div>

  <!-- Main Layout -->
  <div class="dashboard-wrapper">

    <!-- Filters -->
    <div class="filters">
      <div class="reset-filter" (click)="resetFilters()">Reset Filter</div>

      <label>State</label>
      <div class="custom-dropdown">
        <input type="text" [(ngModel)]="stateSearchText" (input)="selectedState = ''; stateDropdownOpen = true"
          (focus)="stateDropdownOpen = true" placeholder="Search state..." class="state-search-box" />

        <div class="dropdown-list scroll-box" *ngIf="stateDropdownOpen && filteredStates.length > 0">
          <div class="dropdown-item" *ngFor="let s of filteredStates" (click)="selectState(s)"
            [class.selected]="s._id === selectedState">
            {{ s.name }}
          </div>
        </div>
      </div>

      <label>Population Category</label>
      <select [(ngModel)]="selectedPopulation" (change)="onPopulationOrStateChange()">
         <option value="">Select population category</option>
        <option *ngFor="let p of filters.populationCategories" [value]="p">{{ p }}</option>
      </select>

     
     
      <!-- <div class="custom-multiselect">
       <label class="filter-label">City</label>
      <input type="text" [(ngModel)]="citySearchText" placeholder="Search city..." class="city-search-box" />
      
      <div class="city-checkboxes scroll-box">
        <label *ngFor="let c of filteredCities" class="checkbox-item">
          <input type="checkbox" [value]="c.name" [checked]="selectedCities.includes(c.name)"
            (change)="toggleCitySelection(c.name, $any($event.target).checked)" />
         {{ c.name }} 
        </label>
      </div>
      </div> -->

      <label class="filter-label">City</label>
<input
  type="text"
  [(ngModel)]="citySearchText"
  placeholder="Search city..."
  class="city-search-box"
/>

<!-- <div class="city-checkboxes scroll-box">
  <label *ngFor="let c of filteredCities" class="checkbox-item">
    <input
      type="checkbox"
      [value]="c.name"
      [checked]="selectedCities.includes(c.name)"
      (change)="toggleCitySelection(c.name, $any($event.target).checked)"
    />
    {{ c.name }}
  </label>
</div> -->
<div *ngIf="selectedState && selectedPopulation">
<div class="city-checkboxes scroll-box">
  <label *ngFor="let c of filteredCities" class="checkbox-item">
    <input
      type="checkbox"
      [value]="c.name"
      [checked]="selectedCities.includes(c.name)"
      (change)="toggleCitySelection(c.name, $any($event.target).checked)"
    />
    <span>{{ c.name }}</span>
  </label>
</div>
</div>

      

      <label>Year</label>
      <select [(ngModel)]="selectedYear">
        <option value="">Select Year</option>
        <option *ngFor="let y of filters.years" [value]="y.name">{{ y.name }}</option>
      </select>

      
<label>Document Type</label>
<div class="grouped-dropdown">
  <div *ngFor="let group of filters.documentTypes">
    <div class="group-heading">{{ group.heading }}</div>
    <div *ngFor="let d of group.items" class="group-option">
      <label>
        <input type="radio" name="docType" [value]="d.key" [(ngModel)]="selectedDocType" (ngModelChange)="onDocTypeChange($event)"/>
         {{ d.name }}
      </label>
    </div>
  </div>
</div>


<div class="audited-radio-container" *ngIf="selectedDocType !== '16th_fc'">
  <label>
    <input
      type="radio"
      name="auditType"
      [value]="true"
      [(ngModel)]="isAudited"
    />
    Audited
  </label>
  <label style="margin-left: 10px;">
    <input
      type="radio"
      name="auditType"
      [value]="false"
      [(ngModel)]="isAudited"
    />
    Unaudited
  </label>
</div>



      <button class="apply-btn" (click)="applyFilters()">Apply</button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
    <div class="placeholder-section" *ngIf="!filtersApplied">
      <div><h4>select filters on the left pane to see the files</h4></div>
      </div>
      <div *ngIf="isLoading" class="loader-overlay">
  <div class="spinner"></div>
  <p>Loading data...</p>
</div>
<!-- Loader -->
<div *ngIf="isLoading" class="loader-overlay">
  <div class="spinner"></div>
  <p>Please wait...</p>
</div>

      <div class="file-results" *ngIf="filtersApplied && filteredFiles.length > 0">
      <h3>Available Files</h3>
     
     <table class="afs-table" *ngIf="filteredFiles.length > 0">
     <thead>
      <tr>
      <th>
       SELECT TO DIGITIZE <input type="checkbox" [(ngModel)]="selectAll" (change)="toggleSelectAll()" /> ALL
      </th>
      <th>State</th>
      <th>City
        <span class="sort-buttons">
         <button (click)="sortByCity('asc')">‚¨ÜÔ∏è</button>
         <button (click)="sortByCity('desc')">‚¨áÔ∏è</button>
        </span>
        </th>
      <th>ULB Code
        <span class="sort-buttons">
        <button (click)="sortByULBCode('asc')">‚¨ÜÔ∏è</button>
        <button (click)="sortByULBCode('desc')">‚¨áÔ∏è</button>
        </span>
      </th>
      <th>PDF DOCUMENT</th>
      

      <th>Form Status</th>
      <th>Digitize Status</th>
      <th>Form Uploaded On</th>
      <th>Form Digitized On</th>
      <th>Request ID / Log</th>
    </tr>
  </thead>
   <tbody>
    <tr *ngFor="let file of filteredFiles" [ngClass]="{'active-row':  activeRow === file}">
       <td>
        <input type="checkbox" [(ngModel)]="file.selected" (change)="updateSelection()" />
      </td>
     
      <td>{{ file.stateName }}</td>
      <td>{{ file.cityName }}</td>
      <td>{{ file.ulbCode }}</td>

<td>
  <!-- Main Ledger file -->
  <ng-container *ngIf="file.previewUrl; else useBackendFile">
    <a [href]="file.previewUrl" target="_blank" (click)="setActiveRow(file); $event.stopPropagation()" >{{ file.fileName }}</a>
    <div class="page-count" *ngIf="file.pageCount !== undefined">
      ({{ file.pageCount }} pages)
    </div>
  </ng-container>

  <ng-template #useBackendFile>
    <ng-container *ngIf="file.fileUrl; else noFileAvailable">
      <a [href]="storageBaseUrl + file.fileUrl" target="_blank" (click)="setActiveRow(file); $event.stopPropagation()">{{ file.fileName }}</a>
      <div class="page-count" *ngIf="file.pageCount !== undefined">
        ({{ file.pageCount }} pages)
      </div>
    </ng-container>

    <ng-template #noFileAvailable>
      {{ file.fileName }}
      <div class="page-count" *ngIf="file.pageCount !== undefined">
        ({{ file.pageCount }} pages)
      </div>
    </ng-template>
  </ng-template>

  <!-- Separator -->
  <hr class="separator" style="margin-top: 44px;" />

  <!-- AFS Extra Files -->
  <ng-container *ngIf="file.extraFiles && file.extraFiles.length > 0">
    <div *ngFor="let ef of file.extraFiles" style="margin-top: 4px;">
      <a [href]="ef.fileUrl" target="_blank" (click)="setActiveRow(file); $event.stopPropagation()">{{ ef.fileName }}</a>
      <div class="page-count" *ngIf="ef.pageCount !== undefined">
        ({{ ef.pageCount }} pages)
      </div>
    </div>
  </ng-container>

  <!-- Upload Button -->
  <div style="margin-top: 4px;">
    <button class="upload-btn" (click)="setActiveRow(file); triggerFileInput(file)">
      {{ file.extraFiles && file.extraFiles.length > 0 ? 'Re-upload' : 'Upload' }}
    </button>
    <input type="file"
           accept="application/pdf"
           style="display: none"
           (change)="handleFileUpload($event, file)"
           #fileInput
           [attr.data-id]="file.cityName + file.ulbCode" />
  </div>
</td>



     <td>
      {{ file.statusText }}
      <hr class="separator" style="margin-bottom: 42px;" />

     </td>
      <!-- <td></td> -->
<td>
  <div *ngIf="file.excelFiles && file.excelFiles.length > 0; else noExcel">
    <ng-container *ngFor="let excel of file.excelFiles; let i = index">
      DIGITIZED
      <a [href]="excel.fileUrl" target="_blank">
         excelfile.xlsx
      </a>
      <!-- Separator between files (not after the last one) -->
      <hr class="separator" *ngIf="i < file.excelFiles.length - 1" />
    </ng-container>
  </div>
  <ng-template #noExcel>
    NOT DIGITIZED
  </ng-template>
</td>

      <td><hr class="separator" /></td>
      <td>
         <div *ngIf="file.excelFiles && file.excelFiles.length > 0">
          <ng-container *ngFor="let excel of file.excelFiles; let i = index">
             {{ excel.uploadedAt | date:'short' }}
            <!-- Separator between timestamps (not after the last one) -->
             <hr class="separator" *ngIf="i < file.excelFiles.length - 1" />
          </ng-container>
        </div>
      </td>
      <td><hr class="separator" /></td>
    </tr>
  </tbody>
</table>
<div *ngIf="selectedFilesCount > 0" class="selection-summary">
  <strong>{{ totalSelectedPages }} pages</strong> from 
  <strong>{{ selectedFilesCount }} PDF file(s)</strong> selected to digitize

</div>

<div>
     
  <button class="digitize-btn" (click)="openDigitizePopup()">Digitize & Download</button>
</div>
<!-- Digitize Popup -->
<div class="popup-overlay" *ngIf="showDigitizePopup">
  <div class="popup-box">
    <h3>Confirm Digitization</h3>
    <p>
      You have selected <strong>{{ selectedFilesCount }}</strong> file(s) 
      containing <strong>{{ totalSelectedPages }}</strong> pages.
    </p>

    <div *ngIf="digitizeStatus === ''">
      <button class="proceed-btn" (click)="proceedDigitization()">Proceed</button>
      <button class="cancel-btn" (click)="closeDigitizePopup()">Cancel</button>
    </div>

    <div *ngIf="digitizeStatus === 'done'">
      <p style="color: green; font-weight: bold;"> Done</p>
      <button (click)="closeDigitizePopup()">Close</button>
    </div>
  </div>
</div>
</div>
<div *ngIf="filtersApplied && filteredFiles.length === 0" class="no-files-msg">
  No files found for the selected filters.
</div>
</div>
</div>

</div>
